<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no"/>
    <base href="/"/>
    <title>Eloquent ORM - Laravel 开发笔记</title>
    <link rel="shortcut icon" type="image/x-icon" href="../../web/images/favicon.ico"/>
    <link rel="stylesheet" type="text/css" href="../../web/css/notes.css"/>
    <style>
        table p,
        table ul {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
<main>
    <article>
        <h1>Eloquent ORM</h1>

        <h2>什么是 ORM</h2>
        <p>ORM 即 Object-Relational Mapping 对象关系映射，作用是在【关系型数据库】和【对象】之间建立映射，这样在处理对象时就不用和复杂的 SQL 语句打交道，只需操作对象的属性或方法。</p>
        <p>面向对象是从软件工程发展而来，而关系数据库是从数学理论发展而来，两者的发展路径不同。
            随着数据持久化成为软件项目的必要因素，为了让开发人员专注于业务，简化数据操作，ORM 应运而生。它的出现正是为了解决【面向对象】与【关系型数据库】之间存在的不匹配。</p>

        <h2>Laravel 的 ORM</h2>
        <p>Laravel 封装了一套自己的 ORM，有 Model、Relationships、Collection 几个主要概念，基本是围绕 Model 对数据进行操作。</p>

        <p>Laravel 的 Model 继承 <code>\Illuminate\Database\Eloquent\Model</code> 类，详情参考官网文档
            <a target="_blank" href="https://laravel.com/docs/5.5/eloquent">https://laravel.com/docs/5.5/eloquent</a>。
        </p>

        <p>Laravel 的 Collection 继承 <code>\Illuminate\Database\Eloquent\Collection</code> 类，详情参考官网文档
            <a target="_blank" href="https://laravel.com/docs/5.5/eloquent-collections">https://laravel.com/docs/5.5/eloquent-collections</a>。
        </p>

        <h3>数据库检索</h3>

        <p>下面整理了一些常见的数据库检索方法：</p>

        <p>以官网举的 Flight 类为例，可通过以下【静态方法】直接获得 Model：</p>
        <table class="list">
            <tr>
                <th><code>Flight::find($id, $columns = ['*'])</code></th>
                <td>根据指定 ID 检索数据库，失败时返回 <code>null</code></td>
            </tr>
            <tr>
                <th><code>Flight::findOrFail($id, $columns = ['*'])</code></th>
                <td>根据指定 ID 检索数据库，失败时抛出 <code>\Illuminate\Database\Eloquent\ModelNotFoundException</code></td>
            </tr>
            <tr>
                <th><code>Flight::findOrNew($id, $columns = ['*'])</code></th>
                <td>根据指定 ID 检索数据库，失败时返回空实例</td>
            </tr>
            <tr>
                <th><code>Flight::firstOrNew(array $attributes, array $values = [])</code></th>
                <td>根据 <code>$attributes</code> 数组检索数据库，失败时返回由 <code>$attributes</code> 及 <code>$values</code> 填充的新实例
                </td>
            </tr>
            <tr>
                <th><code>Flight::firstOrCreate(array $attributes, array $values = [])</code></th>
                <td>根据 <code>$attributes</code> 数组检索数据库，失败时返回由 <code>$attributes</code> 及 <code>$values</code>
                    填充的新实例，并创建一条对应的数据库记录
                </td>
            </tr>
        </table>

        <p>可通过以下【静态方法】创建 Query Builder（<code>\Illuminate\Database\Eloquent\Builder</code>）：
        </p>
        <table class="list">
            <tr>
                <th><code>Flight::query()</code></th>
                <td>返回一个新的 Query Builder 实例</td>
            </tr>
            <tr>
                <th><code>Flight::on($connection = null)</code></th>
                <td>根据指定 <code>$connection</code> 创建一个新的 Query Builder 实例</td>
            </tr>
            <tr>
                <th><code>Flight::where($column, $operator = null, $value = null, $boolean = 'and')</code></th>
                <td>根据字段 <code>$column</code>、条件 <code>$operator</code>、值 <code>$value</code> 检索数据库</td>
            </tr>
        </table>

        <p>可通过 Query Builder 的以下方法获得 Model：</p>
        <table class="list">
            <tr>
                <th><code>first($columns = ['*'])</code></th>
                <td>返回第一个符合条件的结果，找不到数据时返回 <code>null</code></td>
            </tr>
            <tr>
                <th><code>firstOrFail($columns = ['*'])</code></th>
                <td>返回第一个符合条件的结果，找不到数据时抛出 <code>\Illuminate\Database\Eloquent\ModelNotFoundException</code></td>
            </tr>
            <tr>
                <th><code>firstOr($columns = ['*'], Closure $callback = null)</code></th>
                <td>返回第一个符合条件的结果，找不到数据时执行 <code>$callback</code></td>
            </tr>
        </table>

        <p>可通过 Query Builder 的 <code>get</code> 方法，或者以下【静态方法】获得 Collection：</p>
        <table class="list">
            <tr>
                <th><code>Flight::all($columns = ['*'])</code></th>
                <td>检索所有数据库记录</td>
            </tr>
        </table>

        <h3>关联数据检索</h3>

        <p>Laravel 为 Model 定义了专门的方法处理数据表关联，用来获取与其关联的 Model 实例或者 Collection 实例。</p>

        <table class="list">
            <tr>
                <th><a target="_blank" href="https://laravel.com/docs/5.5/eloquent-relationships#one-to-one">一对一</a>
                </th>
                <td>
                    <p><code>hasOne($related, $foreignKey = null, $localKey = null)</code></p>
                    <ul>
                        <li><code>$related</code> - 关联类类名</li>
                        <li><code>$foreignKey</code> - 主类的数据表外键</li>
                        <li><code>$localKey</code> - 关联类数据表的链接键（默认为主键）</li>
                    </ul>
                    <p>其 <code>getResults</code> 方法返回 Model</p>
                </td>
            </tr>
            <tr>
                <th>
                    <a target="_blank" href="https://laravel.com/docs/5.5/eloquent-relationships#one-to-many">一对多</a>
                </th>
                <td>
                    <p><code>hasMany($related, $foreignKey = null, $localKey = null)</code></p>
                    <ul>
                        <li><code>$related</code> - 关联类类名</li>
                        <li><code>$foreignKey</code> - 主类的数据表外键</li>
                        <li><code>$localKey</code> - 关联类数据表的链接键（默认为主键）</li>
                    </ul>
                    <p>其 <code>getResults</code> 方法返回 Collection</p>
                </td>
            </tr>
            <tr>
                <th><a target="_blank" href="https://laravel.com/docs/5.5/eloquent-relationships#one-to-many-inverse">一对多
                    - 反向</a></th>
                <td>
                    <p><code>belongsTo($related, $foreignKey = null, $ownerKey = null, $relation = null)</code></p>
                    <ul>
                        <li><code>$related</code> - 关联类类名</li>
                        <li><code>$foreignKey</code> - 关联类的数据表外键</li>
                        <li><code>$ownerKey</code> - 主类的数据表链接键（默认为主键）</li>
                        <li><code>$relation</code> - 为此关系命名（唯一）</li>
                    </ul>
                    <p>其 <code>getResults</code> 方法返回 Model</p>
                </td>
            </tr>
            <tr>
                <th><a target="_blank"
                       href="https://laravel.com/docs/5.5/eloquent-relationships#has-many-through">一对多链接</a></th>
                <td>
                    <p><code>hasManyThrough($related, $through, $firstKey = null, $secondKey = null, $localKey = null,
                        $secondLocalKey = null)</code></p>
                    <ul>
                        <li><code>$related</code> - 关联类类名</li>
                        <li><code>$through</code> - 中间类类名</li>
                        <li><code>$firstKey</code> - 中间类的数据表与主类链接的外键</li>
                        <li><code>$secondKey</code> - 关联类的数据表与中间类链接的外键</li>
                        <li><code>$localKey</code> - 主类的数据表链接键（默认为主键）</li>
                        <li><code>$secondLocalKey</code> - 中间类的数据表链接键（默认为主键）</li>
                    </ul>
                    <p>其 <code>getResults</code> 方法返回 Collection</p>
                </td>
            </tr>
            <tr>
                <th><a target="_blank" href="https://laravel.com/docs/5.5/eloquent-relationships#polymorphic-relations">一对多
                    - 多态关联</a></th>
                <td>
                    <ul>
                        <li>
                            <p><code>morphTo($name = null, $type = null, $id = null)</code></p>
                            <ul>
                                <li><code>$name</code> - 【态】名</li>
                                <li><code>$type</code> - 指定数据表的关联类型字段名，默认为 <code>$name + '_type'</code></li>
                                <li><code>$id</code> - 指定数据表的关联 ID 字段名，默认为 <code>$name + '_id'</code></li>
                            </ul>
                            <p> 其 <code>getResults</code> 方法返回 Model</p>
                        </li>
                        <li>
                            <p><code>morphMany($related, $name, $type = null, $id = null, $localKey = null)</code></p>
                            <ul>
                                <li><code>$related</code> - 关联类类名</li>
                                <li><code>$name</code> - 【态】名</li>
                                <li><code>$type</code> - 指定数据表的关联类型字段名，默认为 <code>$name + '_type'</code></li>
                                <li><code>$id</code> - 指定数据表的关联 ID 字段名，默认为 <code>$name + '_id'</code></li>
                                <li><code>$localKey</code> - 主类的数据表链接键（默认为主键）</li>
                            </ul>
                            <p>其 <code>getResults</code> 方法返回 Collection</p>
                        </li>
                    </ul>
                </td>
            </tr>
            <tr>
                <th><a target="_blank" href="https://laravel.com/docs/5.5/eloquent-relationships#many-to-many">多对多</a>
                </th>
                <td>
                    <p><code>belongsToMany($related, $table = null, $foreignPivotKey = null, $relatedPivotKey = null,
                        $parentKey = null, $relatedKey = null, $relation = null)</code></p>
                    <ul>
                        <li><code>$related</code> - 关联类类名</li>
                        <li><code>$table</code> - 中间表表名</li>
                        <li><code>$foreignPivotKey</code> - 中间表与主类链接的外键</li>
                        <li><code>$relatedPivotKey</code> - 中间表与关联类链接的外键</li>
                        <li><code>$parentKey</code> - 主类的数据表链接键（默认为主键）</li>
                        <li><code>$relatedKey</code> - 关联类的数据表链接键（默认为主键）</li>
                        <li><code>$relation</code> - 为此关系命名（唯一）</li>
                    </ul>
                    <p>其 <code>getResults</code> 方法返回 Collection</p>
                </td>
            </tr>
            <tr>
                <th><a target="_blank"
                       href="https://laravel.com/docs/5.5/eloquent-relationships#many-to-many-polymorphic-relations">多对多
                    - 多态关联</a></th>
                <td>
                    <ul>
                        <li>
                            <p><code>morphToMany($related, $name, $table = null, $foreignPivotKey = null,
                                $relatedPivotKey = null, $parentKey = null,
                                $relatedKey = null, $inverse = false)</code></p>
                            <ul>
                                <li><code>$related</code> - 关联类类名</li>
                                <li><code>$name</code> - 【态】名</li>
                                <li><code>$table</code> - 中间表表名</li>
                                <li><code>$foreignPivotKey</code> - 中间表与主类链接的外键</li>
                                <li><code>$relatedPivotKey</code> - 中间表与关联类链接的外键</li>
                                <li><code>$parentKey</code> - 主类的数据表链接键（默认为主键）</li>
                                <li><code>$relatedKey</code> - 关联类的数据表链接键（默认为主键）</li>
                                <li><code>$inverse</code> -</li>
                            </ul>
                            <p> 其 <code>getResults</code> 方法返回Collection</p>
                        </li>
                        <li>
                            <p><code>morphedByMany($related, $name, $table = null, $foreignPivotKey = null,
                                $relatedPivotKey = null, $parentKey = null, $relatedKey = null)</code></p>
                            <ul>
                                <li><code>$related</code> - 关联类类名</li>
                                <li><code>$name</code> - 【态】名</li>
                                <li><code>$table</code> - 中间表表名</li>
                                <li><code>$foreignPivotKey</code> - 中间表与主类链接的外键</li>
                                <li><code>$relatedPivotKey</code> - 中间表与关联类链接的外键</li>
                                <li><code>$parentKey</code> - 主类的数据表链接键（默认为主键）</li>
                                <li><code>$relatedKey</code> - 关联类的数据表链接键（默认为主键）</li>
                            </ul>
                            <p> 其 <code>getResults</code> 方法返回 Collection</p>
                        </li>
                    </ul>
                </td>
            </tr>
        </table>

        <h3>数据更新</h3>

        <p>Laravel 为 Model 定义了如下【静态方法】来更新数据库：</p>
        <table class="list">
            <tr>
                <th><code>Flight::create(array $attributes = [])</code></th>
                <td>为数据库创建一条由 <code>$attributes</code> 填充的新纪录，并返回对应实例</td>
            </tr>
            <tr>
                <th><code>Flight::updateOrCreate(array $attributes, array $values = [])</code></th>
                <td>根据 <code>$attributes</code> 数组检索数据库，找到结果则以 <code>$values</code> 进行更新，否则创建一条由
                    <code>$attributes</code> 及 <code>$values</code> 填充的新纪录
                </td>
            </tr>
        </table>

        <p>对 Model 实例可使用如下方法：</p>
        <table class="list">
            <tr>
                <th><code>save(array $options = [])</code></th>
                <td>将当前实例的数据保存到数据库，成功时返回 <code>true</code>，否则返回 <code>false</code></td>
            </tr>
            <tr>
                <th><code>saveOrFail(array $options = [])</code></th>
                <td>将当前实例的数据保存到数据库，成功时返回 <code>true</code>，否则抛出异常</td>
            </tr>
            <tr>
                <th><code>update(array $attributes = [], array $options = [])</code></th>
                <td>相当于先执行 <code>fill($attributes)</code>，再执行 <code>save($options)</code></td>
            </tr>
            <tr>
                <th><code>push()</code></th>
                <td>将当前实例及其关联实例的数据保存到数据库，成功时返回 <code>true</code>，否则返回 <code>false</code></td>
            </tr>
        </table>

        <p>也可以通过 Query Builder 的 <code>update(array $values)</code> 方法根据指定条件批量更新。</p>

        <h3>魔术方法</h3>
        <p>Laravel 为 Model 定义了魔术方法 <code>__call</code> 和 <code>__callStatic</code>，这使一些不在 Model
            类中直接定义的方法也得以执行。比如，下述方法实际是在 Query Builder 类中定义的：</p>
        <ul>
            <li><code>find</code></li>
            <li><code>findOrFail</code></li>
            <li><code>findOrNew</code></li>
            <li><code>firstOrNew</code></li>
            <li><code>firstOrCreate</code></li>
            <li><code>where</code></li>
            <li><code>orWhere</code></li>
            <li><code>create</code></li>
            <li><code>updateOrCreate</code></li>
        </ul>

    </article>
</main>
<script src="../../web/js/lib/require.js" type="text/javascript"></script>
<script src="../../web/js/require-config.js" type="text/javascript"></script>
<script src="../../web/js/notes.js" type="text/javascript"></script>
</body>
</html>